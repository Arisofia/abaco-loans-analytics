name: "Vibe Solutioning Quality Gate"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  vibe_quality_gate:
    name: "Vibe Solutioning Gate"
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SOURCERY_TOKEN: ${{ secrets.SOURCERY_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip & install runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black==24.3.0 flake8==7.1.0 sourcery-cli==0.8.0
          npm install -g sonar-scanner
          npm --version

      - name: Run unit tests
        run: |
          python -m pytest

      - name: Black check
        run: |
          black --check .

      - name: Flake8 lint
        run: |
          flake8 .

      - name: Sourcery review
        env:
          SOURCERY_TOKEN: ${{ secrets.SOURCERY_TOKEN }}
        run: |
          sourcery review .

      - name: SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=abaco-loans-analytics \
            -Dsonar.projectName="Abaco Loans Analytics" \
            -Dsonar.sources=. \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.login=${{ env.SONAR_TOKEN }}
