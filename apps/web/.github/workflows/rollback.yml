name: Rollback - Emergency Recovery

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "Version tag to rollback to (e.g., v1.0.0)"
        required: true
        type: string
      environment:
        description: "Environment to rollback"
        required: true
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  deployments: write

jobs:
  pre-rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [[ ! "${{ github.event.inputs.target_version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format. Use semantic versioning (e.g., v1.0.0)"
            exit 1
          fi
          echo "✅ Rollback to version: ${{ github.event.inputs.target_version }}"
          echo "✅ Target environment: ${{ github.event.inputs.environment }}"

      - name: Create incident issue
        uses: actions/github-script@v6
        env:
          TARGET_VERSION: ${{ github.event.inputs.target_version }}
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          INITIATED_BY: ${{ github.actor }}
        with:
          script: |
            const title = `[INCIDENT] Rollback initiated - ${process.env.ENVIRONMENT}`;
            const body = `
            ## Rollback Details
            - **Target Version**: ${process.env.TARGET_VERSION}
            - **Environment**: ${process.env.ENVIRONMENT}
            - **Initiated By**: @${process.env.INITIATED_BY}
            - **Timestamp**: ${new Date().toISOString()}

            See OPERATIONS.md for details.
            `;
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['incident', 'rollback']
            });

  approval-gate:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}-rollback
    steps:
      - name: Confirm rollback
        run: echo "✅ Rollback approved for ${{ github.event.inputs.environment }}"

  execute-rollback:
    runs-on: ubuntu-latest
    needs: [pre-rollback, approval-gate]
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_version }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: pnpm

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build target version
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets[format('{0}_SUPABASE_URL', github.event.inputs.environment == 'production' && 'PROD' || 'STAGING')] }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets[format('{0}_SUPABASE_KEY', github.event.inputs.environment == 'production' && 'PROD' || 'STAGING')] }}
          NODE_ENV: production

      - name: Deploy rolled-back version
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets[format('AZURE_STATIC_WEB_APPS_TOKEN_{0}', github.event.inputs.environment == 'production' && 'PROD' || 'STAGING')] }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: ".next"
          app_build_command: "pnpm build"

  post-rollback-validation:
    runs-on: ubuntu-latest
    needs: execute-rollback
    steps:
      - name: Health check
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [ "$ENV" = "production" ]; then
            URL="https://abaco-loans-analytics.com"
          else
            URL="https://staging.abaco-loans-analytics.com"
          fi

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Rollback successful - Service is healthy"
            exit 0
          else
            echo "❌ Health check failed after rollback (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Notify completion
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 1,
              body: `✅ Rollback to ${{ github.event.inputs.target_version }} completed successfully for ${{ github.event.inputs.environment }}`
            });

  rollback-failure-notification:
    runs-on: ubuntu-latest
    needs: [execute-rollback, post-rollback-validation]
    if: failure()
    steps:
      - name: Create failure alert
        uses: actions/github-script@v6
        env:
          TARGET_VERSION: ${{ github.event.inputs.target_version }}
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CRITICAL] Rollback FAILED - ${process.env.ENVIRONMENT}`,
              body: `
              ## Rollback Failure Details
              - **Version**: ${process.env.TARGET_VERSION}
              - **Environment**: ${process.env.ENVIRONMENT}
              - **Action**: https://github.com/${process.env.REPO}/actions/runs/${process.env.RUN_ID}
              
              **IMMEDIATE ACTION REQUIRED** - Manual intervention needed.
              See OPERATIONS.md incident response procedures.
              `,
              labels: ['critical', 'incident', 'rollback-failed']
            });
