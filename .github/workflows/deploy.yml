name: Deploy to Vercel

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "apps/web/src/**"
      - "apps/web/public/**"
      - "apps/web/package.json"
      - "apps/web/next.config.js"
      - "package.json"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: apps/web/pnpm-lock.yaml

      - name: Check Vercel secrets
        id: vercel_secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          sanitize_secret() {
            local var_name="$1"
            local raw="$2"
            local norm
            norm="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]' | xargs)"
            case "$norm" in
              ""|"token"|"tokens"|"secret"|"secrets"|"changeme"|"change-me"|"change_me"|"replace-me"|"replace_me"|"placeholder"|"example"|"redacted")
                printf -v "$var_name" '%s' ""
                ;;
              *)
                printf -v "$var_name" '%s' "$raw"
                ;;
            esac
          }
          sanitize_secret VERCEL_TOKEN "$VERCEL_TOKEN"
          sanitize_secret VERCEL_ORG_ID "$VERCEL_ORG_ID"
          sanitize_secret VERCEL_PROJECT_ID "$VERCEL_PROJECT_ID"

          missing=""
          [ -z "$VERCEL_TOKEN" ] && missing="$missing VERCEL_TOKEN"
          [ -z "$VERCEL_ORG_ID" ] && missing="$missing VERCEL_ORG_ID"
          [ -z "$VERCEL_PROJECT_ID" ] && missing="$missing VERCEL_PROJECT_ID"
          if [ -z "$missing" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Missing Vercel secrets:$missing"
          fi

      - name: Check AWS secrets
        id: aws_secrets
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          sanitize_secret() {
            local var_name="$1"
            local raw="$2"
            local norm
            norm="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]' | xargs)"
            case "$norm" in
              ""|"token"|"tokens"|"secret"|"secrets"|"changeme"|"change-me"|"change_me"|"replace-me"|"replace_me"|"placeholder"|"example"|"redacted")
                printf -v "$var_name" '%s' ""
                ;;
              *)
                printf -v "$var_name" '%s' "$raw"
                ;;
            esac
          }
          sanitize_secret AWS_S3_BUCKET "$AWS_S3_BUCKET"
          sanitize_secret AWS_ACCESS_KEY_ID "$AWS_ACCESS_KEY_ID"
          sanitize_secret AWS_SECRET_ACCESS_KEY "$AWS_SECRET_ACCESS_KEY"

          if [ -n "$AWS_S3_BUCKET" ] && [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "::warning::AWS secrets not fully configured, skipping S3 upload"
          fi

      - name: Install dependencies
        run: |
          pnpm -C apps/web install --frozen-lockfile

      - name: Pull Vercel project settings
        if: steps.vercel_secrets.outputs.present == 'true'
        working-directory: apps/web
        run: npx vercel pull --yes --environment=production --token "${{ secrets.VERCEL_TOKEN }}"

      - name: Build
        run: |
          pnpm -C apps/web build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Upload build artifact (local)
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/.next

      - name: Upload build to S3 (cloud)
        if: steps.aws_secrets.outputs.present == 'true'
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --acl private --follow-symlinks
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: "us-east-1"
          SOURCE_DIR: "apps/web/.next"

      - name: Deploy to Vercel
        if: steps.vercel_secrets.outputs.present == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: apps/web

      - name: Skip deploy (missing Vercel secrets)
        if: steps.vercel_secrets.outputs.present != 'true'
        run: |
          echo "Skipping Vercel deploy: VERCEL_TOKEN/ORG_ID/PROJECT_ID not configured."
