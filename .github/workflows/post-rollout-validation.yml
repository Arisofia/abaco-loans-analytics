name: Post-Rollout Validation
on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *" # daily at 7am UTC
jobs:
  validate-meta-cascade-figma:
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets availability
        id: check-secrets
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          FIGMA_NODE_ID: ${{ secrets.FIGMA_NODE_ID }}
        run: |
          sanitize_secret() {
            local var_name="$1"
            local raw="$2"
            local norm
            norm="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]' | xargs)"
            case "$norm" in
              ""|"token"|"tokens"|"secret"|"secrets"|"changeme"|"change-me"|"change_me"|"replace-me"|"replace_me"|"placeholder"|"example"|"redacted")
                printf -v "$var_name" '%s' ""
                ;;
              *)
                printf -v "$var_name" '%s' "$raw"
                ;;
            esac
          }
          sanitize_secret AWS_S3_BUCKET "$AWS_S3_BUCKET"
          sanitize_secret AWS_ACCESS_KEY_ID "$AWS_ACCESS_KEY_ID"
          sanitize_secret AWS_SECRET_ACCESS_KEY "$AWS_SECRET_ACCESS_KEY"
          sanitize_secret FIGMA_TOKEN "$FIGMA_TOKEN"
          sanitize_secret FIGMA_FILE_KEY "$FIGMA_FILE_KEY"
          sanitize_secret FIGMA_NODE_ID "$FIGMA_NODE_ID"

          if [ -n "$AWS_S3_BUCKET" ]; then
            echo "aws_available=true" >> $GITHUB_OUTPUT
          else
            echo "aws_available=false" >> $GITHUB_OUTPUT
          fi
          if [ -n "$FIGMA_TOKEN" ] && [ -n "$FIGMA_FILE_KEY" ] && [ -n "$FIGMA_NODE_ID" ]; then
            echo "figma_available=true" >> $GITHUB_OUTPUT
          else
            echo "figma_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib pyarrow requests
      - name: Validate Meta Insights Data
        if: ${{ hashFiles('data/warehouse/meta_insights.parquet') != '' }}
        run: |
          python -c "import pandas as pd; df = pd.read_parquet('data/warehouse/meta_insights.parquet'); assert not df.empty, 'Meta insights data is empty!'; print('Meta insights records:', len(df))"
      - name: Validate Cascade Data
        if: ${{ hashFiles('data/metrics/*.csv') != '' }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import pandas as pd

          metrics_dir = Path("data/metrics")
          csvs = sorted(metrics_dir.glob("*.csv"))
          if not csvs:
              raise SystemExit("No Cascade CSV files found")

          latest = max(csvs, key=lambda p: p.stat().st_mtime)
          df = pd.read_csv(latest)
          assert not df.empty, "Cascade data is empty!"
          print("Cascade records:", len(df), "file:", latest)
          PY
      - name: Validate Figma Dashboard Images
        if: ${{ steps.check-secrets.outputs.aws_available == 'true' }}
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          python - <<'PY'
          import os
          import requests

          bucket = os.environ["AWS_S3_BUCKET"]
          urls = [
              f"https://{bucket}.s3.amazonaws.com/figma_dashboard/top_ads_spend.png",
              f"https://{bucket}.s3.amazonaws.com/figma_dashboard/daily_spend_trend.png",
              f"https://{bucket}.s3.amazonaws.com/figma_dashboard/spend_anomalies.png",
          ]

          for url in urls:
              r = requests.get(url, timeout=15)
              assert r.status_code == 200, f"Image not found: {url}"
              print(f"Image OK: {url}")
          PY
      - name: Validate Figma API Node Update
        if: ${{ steps.check-secrets.outputs.figma_available == 'true' }}
        env:
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          FIGMA_NODE_ID: ${{ secrets.FIGMA_NODE_ID }}
        run: |
          curl -H "X-Figma-Token: $FIGMA_TOKEN" "https://api.figma.com/v1/files/$FIGMA_FILE_KEY/nodes?ids=$FIGMA_NODE_ID"
