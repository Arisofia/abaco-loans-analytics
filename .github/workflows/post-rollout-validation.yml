name: Post-Rollout Validation
on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *' # daily at 7am UTC
jobs:
  validate-meta-cascade-figma:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib pyarrow requests
      - name: Validate Meta Insights Data
        if: hashFiles('data/warehouse/meta_insights.parquet') != ''
        run: |
          python -c "import pandas as pd; df = pd.read_parquet('data/warehouse/meta_insights.parquet'); assert not df.empty, 'Meta insights data is empty!'; print('Meta insights records:', len(df))"
      - name: Validate Cascade Data
        if: hashFiles('data/metrics/*.csv') != ''
        run: |
          python - <<'PY'
          from pathlib import Path
          import pandas as pd

          metrics_dir = Path("data/metrics")
          csvs = sorted(metrics_dir.glob("*.csv"))
          if not csvs:
              raise SystemExit("No Cascade CSV files found")

          latest = max(csvs, key=lambda p: p.stat().st_mtime)
          df = pd.read_csv(latest)
          assert not df.empty, "Cascade data is empty!"
          print("Cascade records:", len(df), "file:", latest)
          PY
      - name: Validate Figma Dashboard Images
        
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          python - <<'PY'
          import os
          import requests

          bucket = os.environ["AWS_S3_BUCKET"]
          urls = [
              f"https://{bucket}.s3.amazonaws.com/figma_dashboard/top_ads_spend.png",
              f"https://{bucket}.s3.amazonaws.com/figma_dashboard/daily_spend_trend.png",
              f"https://{bucket}.s3.amazonaws.com/figma_dashboard/spend_anomalies.png",
          ]

          for url in urls:
              r = requests.get(url, timeout=15)
              assert r.status_code == 200, f"Image not found: {url}"
              print(f"Image OK: {url}")
          PY
      - name: Validate Figma API Node Update
        
        env:
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          FIGMA_NODE_ID: ${{ secrets.FIGMA_NODE_ID }}
        run: |
          curl -H "X-Figma-Token: $FIGMA_TOKEN" "https://api.figma.com/v1/files/$FIGMA_FILE_KEY/nodes?ids=$FIGMA_NODE_ID"
