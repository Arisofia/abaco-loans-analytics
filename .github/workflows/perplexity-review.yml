name: Perplexity Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  perplexity-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Check secrets availability
        id: check-secrets
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          if [ -n "$PERPLEXITY_API_KEY" ]; then
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          else
            echo "secrets_available=false" >> $GITHUB_OUTPUT
            echo "::warning::PERPLEXITY_API_KEY not configured - skipping review"
          fi

      - name: Checkout code
        if: steps.check-secrets.outputs.secrets_available == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        if: steps.check-secrets.outputs.secrets_available == 'true'
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "diff_size=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Review with Perplexity
        if: steps.check-secrets.outputs.secrets_available == 'true' && fromJSON(steps.diff.outputs.diff_size || '0') < 50000
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$PERPLEXITY_API_KEY" ]; then
            echo "Error: PERPLEXITY_API_KEY is not set."
            exit 1
          fi

          # Construct JSON payload safely using jq
          DIFF_TEXT=$(cat pr_diff.txt | head -c 10000)
          jq -n --arg diff "$DIFF_TEXT" \
            '{
              model: "sonar-pro",
              messages: [
                {role: "system", content: "You are a code reviewer. Review the following PR diff for data ingestion requirements, security issues, and code quality."},
                {role: "user", content: $diff}
              ]
            }' > request.json

          # Call Perplexity API to review the changes
          HTTP_CODE=$(curl -s -S -w "%{http_code}" -o review_response.json -X POST "https://api.perplexity.ai/chat/completions" \
            -H "Authorization: Bearer $PERPLEXITY_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Perplexity API returned status $HTTP_CODE"
            cat review_response.json
            exit 1
          fi

          # Extract review and post as comment
          if ! jq empty review_response.json; then
            echo "‚ùå Invalid JSON response from Perplexity API"
            exit 1
          fi

          review_text=$(jq -r '.choices[0].message.content' review_response.json)
          if [ -z "$review_text" ] || [ "$review_text" = "null" ]; then
            echo "‚ùå No review content in API response"
            exit 1
          fi

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ü§ñ Perplexity AI Review\n\n$review_text" || {
              echo "‚ùå Failed to post comment to PR"
              exit 1
            }
