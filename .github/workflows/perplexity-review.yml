name: Perplexity Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  perplexity-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "diff_size=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT
      
      - name: Review with Perplexity
        if: fromJSON(steps.diff.outputs.diff_size) < 50000
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "$PERPLEXITY_API_KEY" ]; then
            echo "Error: PERPLEXITY_API_KEY is not set."
            exit 1
          fi

          # Construct JSON payload safely using jq
          DIFF_TEXT=$(cat pr_diff.txt | head -c 10000)
          jq -n --arg diff "$DIFF_TEXT" \
            '{
              model: "llama-3.1-sonar-large-128k-online",
              messages: [
                {role: "system", content: "You are a code reviewer. Review the following PR diff for data ingestion requirements, security issues, and code quality."},
                {role: "user", content: $diff}
              ]
            }' > request.json

          # Call Perplexity API to review the changes
          HTTP_CODE=$(curl -s -S -w "%{http_code}" -o review_response.json -X POST "https://api.perplexity.ai/chat/completions" \
            -H "Authorization: Bearer $PERPLEXITY_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Perplexity API returned status $HTTP_CODE"
            cat review_response.json
            exit 1
          fi
          
          # Extract review and post as comment
          review_text=$(jq -r '.choices[0].message.content' review_response.json)
          
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ðŸ¤– Perplexity AI Review\n\n$review_text"
