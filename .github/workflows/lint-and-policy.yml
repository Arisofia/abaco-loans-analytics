name: Lint and Policy Enforcement

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]

jobs:
    lint-and-policy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install linters and tools
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt -r dev-requirements.txt
                  pip install jsonlint
                  npm install -g markdownlint-cli

            - name: Lint YAML
              run: |
                  yamllint .

            - name: Lint JSON
              run: |
                  find . -name '*.json' -not -path './node_modules/*' -not -path './.venv/*' -exec jsonlint -q {} \;

            - name: Lint Markdown
              run: |
                  markdownlint '**/*.md' --ignore node_modules --ignore .venv

            - name: Lint Python (pylint, flake8, ruff)
              run: |
                  echo "Running pylint..."
                  PYTHONPATH=src pylint src tests --fail-under=8.0
                  echo "Running flake8..."
                  PYTHONPATH=src flake8 src tests
                  echo "Running ruff..."
                  PYTHONPATH=src ruff check src tests

            - name: Type Check (mypy)
              run: |
                  PYTHONPATH=src mypy src --ignore-missing-imports

            - name: Check for duplicate/stale README and config files
              run: |
                  find . -type f \( -iname 'README*' -o -iname '*example*' -o -iname '*sample*' \) \
                    | grep -vE 'node_modules|.venv|.git|.mypy_cache|.pytest_cache|.ruff_cache|dist|build' \
                    | grep -vE 'dev-requirements.txt|.env.example|.env.local.example' \
                    | grep -vE 'scripts/generate_abaco_portfolio_sample.py' \
                    | grep -vE 'data_samples/abaco_portfolio_sample.csv' \
                    | grep -vE 'config/codex_mcp_config.toml.example' \
                    > doc_files.txt
                  python scripts/security/check_doc_policy.py doc_files.txt

            - name: Run secret scan
              uses: gitleaks/gitleaks-action@v2
              with:
                  config-path: .gitleaks.toml
                  fail: true

            - name: Fail if policy violations found
              if: failure()
              run: exit 1
