name: Lint and Policy Enforcement

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]

jobs:
    lint-and-policy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install linters and tools
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt -r dev-requirements.txt
                  pip install jsonlint
                  npm install -g markdownlint-cli

            - name: Lint YAML
              run: |
                  yamllint .

            - name: Lint JSON
              run: |
                  find . -name '*.json' -not -path './node_modules/*' -not -path './.venv/*' -exec jsonlint -q {} \;

            - name: Lint Markdown
              shell: bash
              run: |
                  set -euo pipefail
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    base="${{ github.event.pull_request.base.sha }}"
                  else
                    base="${{ github.event.before }}"
                  fi
                  head="${{ github.sha }}"
                  candidates=()
                  if [ -n "$base" ] && [ "$base" != "0000000000000000000000000000000000000000" ]; then
                    mapfile -t candidates < <(git diff --name-only "$base" "$head" -- '*.md' || true)
                  fi
                  if [ ${#candidates[@]} -eq 0 ]; then
                    mapfile -t candidates < <(git show --name-only --pretty="" "$head" -- '*.md' || true)
                  fi
                  files=()
                  for file in "${candidates[@]}"; do
                    if [ -f "$file" ]; then
                      files+=("$file")
                    fi
                  done
                  if [ ${#files[@]} -eq 0 ]; then
                    echo "No markdown changes to lint."
                    exit 0
                  fi
                  markdownlint "${files[@]}" --ignore node_modules --ignore .venv

            - name: Lint Python (pylint, flake8, ruff)
              run: |
                  echo "Running pylint..."
                  PYTHONPATH=src pylint src tests --fail-under=8.0
                  echo "Running flake8..."
                  PYTHONPATH=src flake8 src tests
                  echo "Running ruff..."
                  PYTHONPATH=src ruff check src tests

            - name: Type Check (mypy)
              run: |
                  PYTHONPATH=src mypy src --ignore-missing-imports

            - name: Check for duplicate/stale README and config files
              run: |
                  find . -type f \( -iname 'README*' -o -iname '*example*' -o -iname '*sample*' \) \
                    | grep -vE 'node_modules|.venv|.git|.mypy_cache|.pytest_cache|.ruff_cache|dist|build' \
                    | grep -vE 'dev-requirements.txt|.env.example|.env.local.example' \
                    | grep -vE 'scripts/generate_abaco_portfolio_sample.py' \
                    | grep -vE 'data_samples/abaco_portfolio_sample.csv' \
                    | grep -vE 'config/codex_mcp_config.toml.example' \
                    > doc_files.txt
                  python scripts/security/check_doc_policy.py doc_files.txt

            - name: Run secret scan
              uses: gitleaks/gitleaks-action@v2
              with:
                  config-path: .gitleaks.toml
                  fail: true

            - name: Fail if policy violations found
              if: failure()
              run: exit 1
