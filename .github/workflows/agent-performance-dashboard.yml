name: Agent Performance Monitoring
on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    outputs:
      has_scripts: ${{ steps.check.outputs.has_scripts }}
      has_tokens: ${{ steps.check.outputs.has_tokens }}
      slack_available: ${{ steps.check.outputs.slack_available }}
      slack_bot_available: ${{ steps.check.outputs.slack_bot_available }}
      slack_webhook_available: ${{ steps.check.outputs.slack_webhook_available }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        env:
          OPIK_TOKEN: ${{ secrets.OPIK_TOKEN }}
          PHOENIX_TOKEN: ${{ secrets.PHOENIX_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          SCRIPTS=("scripts/query_opik_metrics.py" "scripts/query_phoenix_performance.py" "scripts/calculate_agent_health.py")
          MISSING_SCRIPTS=()
          for s in "${SCRIPTS[@]}"; do
            if [ ! -f "$s" ]; then MISSING_SCRIPTS+=("$s"); fi
          done

          if [ ${#MISSING_SCRIPTS[@]} -eq ${#SCRIPTS[@]} ]; then
            echo "has_scripts=false" >> $GITHUB_OUTPUT
          else
            echo "has_scripts=true" >> $GITHUB_OUTPUT
          fi

          if [ -n "$OPIK_TOKEN" ] || [ -n "$PHOENIX_TOKEN" ]; then
            echo "has_tokens=true" >> $GITHUB_OUTPUT
          else
            echo "has_tokens=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "$SLACK_BOT_TOKEN" ] || [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "slack_available=true" >> $GITHUB_OUTPUT
          else
            echo "slack_available=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "$SLACK_BOT_TOKEN" ]; then
            echo "slack_bot_available=true" >> $GITHUB_OUTPUT
          else
            echo "slack_bot_available=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "slack_webhook_available=true" >> $GITHUB_OUTPUT
          else
            echo "slack_webhook_available=false" >> $GITHUB_OUTPUT
          fi

  monitor:
    needs: check-dependencies
    if: needs.check-dependencies.outputs.has_scripts == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Query Opik for Agent Metrics
        if: hashFiles('scripts/query_opik_metrics.py') != ''
        env:
          OPIK_TOKEN: ${{ secrets.OPIK_TOKEN }}
        run: |
          python scripts/query_opik_metrics.py
      - name: Query Phoenix for Model Performance
        if: hashFiles('scripts/query_phoenix_performance.py') != ''
        env:
          PHOENIX_TOKEN: ${{ secrets.PHOENIX_TOKEN }}
        run: |
          python scripts/query_phoenix_performance.py
      - name: Calculate Agent Health Scores
        if: hashFiles('scripts/calculate_agent_health.py') != ''
        run: |
          python scripts/calculate_agent_health.py
      - name: Detect Degradation
        if: hashFiles('scripts/detect_degradation.py') != ''
        run: |
          python scripts/detect_degradation.py
      - name: Update Figma Agent Health Dashboard
        if: hashFiles('scripts/update_figma_agent_dashboard.py') != ''
        env:
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
        run: |
          python scripts/update_figma_agent_dashboard.py
      - name: Post Summary to Slack (bot) #ops-alerts
        if: always() && needs.check-dependencies.outputs.slack_bot_available == 'true' && hashFiles('scripts/post_to_slack.py') != ''
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          python scripts/post_to_slack.py --channel "#ops-alerts"
      - name: Post Summary to Slack (webhook) #ops-alerts
        if: always() && needs.check-dependencies.outputs.slack_webhook_available == 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Agent Performance Monitoring: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Agent Performance Monitoring*\n*Status:* ${{ job.status }}\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
