name: KPI Parity

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  kpi-parity:
    
    runs-on: ubuntu-latest

    env:
      # Must be set in GitHub Secrets to point to staging/prod analytics DB,
      # e.g. postgresql://user:pass@host:5432/dbname
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies (psql client)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest psycopg[binary] pandas scipy numpy

      - name: Generate KPI JSON via Python engine
        run: |
          mkdir -p exports
          python run_complete_analytics.py

      - name: Apply SQL migrations (analytics views)
        if: env.DATABASE_URL != ''
        run: |
          echo "Applying analytics views migration to $DATABASE_URL"
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f supabase/migrations/20260101_analytics_kpi_views.sql

      - name: Run KPI parity tests (Python vs SQL)
        if: env.DATABASE_URL != ''
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          RUN_KPI_PARITY_TESTS: "1"
        run: |
          pytest -q tests/test_kpi_parity.py

      - name: Skip KPI parity tests (no database configured)
        if: env.DATABASE_URL == ''
        run: |
          echo "::warning::DATABASE_URL secret not configured - skipping KPI parity tests"
          echo "To enable these tests, add DATABASE_URL to repository secrets"
