name: Gemini AI PR Review
permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai requests

      - name: Run Gemini review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          python - <<'PY'
          import os
          import sys
          import textwrap
          import requests
          import google.generativeai as genai

          github_token = os.getenv("GITHUB_TOKEN")
          gemini_key = os.getenv("GEMINI_API_KEY")
          pr_number = os.getenv("PR_NUMBER")
          repo = os.getenv("REPO_FULL_NAME")

          if not github_token or not pr_number or not repo:
              print("Missing GitHub context; skipping Gemini review.")
              sys.exit(0)

          if not gemini_key:
              print("GEMINI_API_KEY not configured; skipping AI review.")
              sys.exit(0)

          headers = {"Authorization": f"token {github_token}", "Accept": "application/vnd.github+json"}
          files_url = f"https://api.github.com/repos/{repo}/pulls/{pr_number}/files"

          try:
              response = requests.get(files_url, headers=headers, timeout=30)
              response.raise_for_status()
              files = response.json()
              diff_chunks = []
              for file in files:
                  patch = file.get("patch")
                  if patch:
                      diff_chunks.append(f"File: {file.get('filename')}\n{patch}")
              diff_text = "\n\n".join(diff_chunks)
          except Exception as exc:  # pragma: no cover - runtime safeguard
              print(f"Failed to fetch PR diff: {exc}")
              sys.exit(0)

          if not diff_text:
              print("No diff content available; skipping Gemini review.")
              sys.exit(0)

          genai.configure(api_key=gemini_key)
          model = genai.GenerativeModel("gemini-1.5-pro")

          prompt = textwrap.dedent(
              """
              You are a senior security and performance reviewer. Analyze the following pull request diff for:
              - Security vulnerabilities (OWASP Top 10)
              - Performance bottlenecks
              - Code cleanliness (DRY, SOLID)
              - Logic errors

              Provide concise findings and actionable suggestions. If there are no issues, reply that the changes look good.
              """
          )

          try:
              result = model.generate_content(f"{prompt}\n\nDiff:\n{diff_text[:12000]}")
              review_comment = result.text.strip()
          except Exception as exc:  # pragma: no cover - API safety
              print(f"Gemini review failed: {exc}")
              sys.exit(0)

          if not review_comment:
              print("Gemini returned no feedback; skipping comment.")
              sys.exit(0)

          comment_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          payload = {"body": f"Gemini Review Summary:\n\n{review_comment}"}

          try:
              post_resp = requests.post(comment_url, headers=headers, json=payload, timeout=30)
              post_resp.raise_for_status()
              print("Posted Gemini review comment.")
          except Exception as exc:  # pragma: no cover - runtime safeguard
              print(f"Failed to post Gemini review: {exc}")
              sys.exit(0)
          PY
        continue-on-error: true
