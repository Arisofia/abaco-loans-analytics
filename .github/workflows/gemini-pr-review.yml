name: Gemini AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai requests

      - name: Run Gemini review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_FULL_NAME: ${{ github.repository }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          python - <<'PY'
          import os
          import sys
          import subprocess
          import textwrap
          import requests
          import google.generativeai as genai

          github_token = os.getenv("GITHUB_TOKEN")
          gemini_key = os.getenv("GEMINI_API_KEY")
          pr_number = os.getenv("PR_NUMBER")
          repo = os.getenv("REPO_FULL_NAME")
          base_ref = os.getenv("BASE_REF")

          if not github_token or not pr_number or not repo:
              print("Missing GitHub context; skipping Gemini review.")
              sys.exit(0)

          if not gemini_key:
              print("GEMINI_API_KEY not configured; skipping AI review.")
              sys.exit(0)

          headers = {"Authorization": f"token {github_token}", "Accept": "application/vnd.github+json"}

          try:
              # Use 3-dot diff to compare PR HEAD against the merge base with the target branch
              diff_text = subprocess.check_output(["git", "diff", f"origin/{base_ref}...HEAD"], stderr=subprocess.STDOUT).decode("utf-8")
          except Exception as exc:  # pragma: no cover - runtime safeguard
              print(f"Failed to fetch PR diff: {exc}")
              sys.exit(0)

          if not diff_text:
              print("No diff content available; skipping Gemini review.")
              sys.exit(0)

          genai.configure(api_key=gemini_key)
          model = genai.GenerativeModel("gemini-1.5-pro")

          prompt = textwrap.dedent(
              """
              You are a senior security and performance reviewer. Analyze the following pull request diff for:
              - Security vulnerabilities (OWASP Top 10)
              - Performance bottlenecks
              - Code cleanliness (DRY, SOLID)
              - Logic errors

              Provide concise findings and actionable suggestions. If there are no issues, reply that the changes look good.
              """
          )

          try:
              result = model.generate_content(f"{prompt}\n\nDiff:\n{diff_text[:12000]}")
              review_comment = result.text.strip()
          except Exception as exc:  # pragma: no cover - API safety
              print(f"Gemini review failed: {exc}")
              sys.exit(0)

          if not review_comment:
              print("Gemini returned no feedback; skipping comment.")
              sys.exit(0)

          comment_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          payload = {"body": f"Gemini Review Summary:\n\n{review_comment}"}

          try:
              post_resp = requests.post(comment_url, headers=headers, json=payload, timeout=30)
              post_resp.raise_for_status()
              print("Posted Gemini review comment.")
          except Exception as exc:  # pragma: no cover - runtime safeguard
              print(f"Failed to post Gemini review: {exc}")
              sys.exit(0)
          PY
        continue-on-error: true
