name: Gemini AI PR Review
on:
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Check Gemini key
        id: gemini_key
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY_SIMPLE }}
        run: |
          if [ -n "$GEMINI_API_KEY" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "GEMINI_API_KEY_SIMPLE not configured; skipping Gemini review." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Install dependencies
        if: steps.gemini_key.outputs.available == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai requests

      - name: Run Gemini review
        if: steps.gemini_key.outputs.available == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY_SIMPLE }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_FULL_NAME: ${{ github.repository }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          python - <<'PY'
          import os
          import sys
          import subprocess
          import textwrap
          import requests
          import google.generativeai as genai

          github_token = os.getenv("GITHUB_TOKEN")
          gemini_key = os.getenv("GEMINI_API_KEY")
          pr_number = os.getenv("PR_NUMBER")
          repo = os.getenv("REPO_FULL_NAME")
          base_ref = os.getenv("BASE_REF")
          model_override = os.getenv("GEMINI_MODEL")

          if not github_token or not pr_number or not repo:
              print("Missing GitHub context; skipping Gemini review.")
              sys.exit(0)

          if not gemini_key:
              print("GEMINI_API_KEY not configured; skipping AI review.")
              sys.exit(0)

          genai.configure(api_key=gemini_key)

          model_name = None
          if model_override:
              model_name = model_override
          else:
              try:
                  for model in genai.list_models():
                      if hasattr(model, "supported_generation_methods") and "generateContent" in model.supported_generation_methods:
                          model_name = model.name
                          break
              except Exception as e:
                  print(f"Could not list Gemini models: {e}")
                  model_name = None

          if not model_name:
              print("No compatible Gemini model found; skipping review.")
              sys.exit(0)

          model = genai.GenerativeModel(model_name)

          # Get diff using git
          try:
              result = subprocess.run(
                  ['git', 'diff', f'origin/{base_ref}', 'HEAD'],
                  capture_output=True,
                  text=True,
                  check=True
              )
              diff = result.stdout
          except subprocess.CalledProcessError as e:
              print(f"Error getting diff: {e}")
              sys.exit(1)

          if not diff.strip():
              print("No changes to review")
              sys.exit(0)

          # Create prompt for Gemini
          prompt = f"""Review this pull request diff and provide feedback on:
          1. Code quality and best practices
          2. Potential bugs or issues
          3. Security concerns
          4. Performance improvements
          5. General suggestions

          Diff:
          {diff[:8000]}  # Limit to avoid token limits
          """

          try:
              response = model.generate_content(prompt)
              review_comment = response.text
          except Exception as e:
              print(f"Error calling Gemini API: {e}")
              sys.exit(0)

          # Post comment to PR
          api_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
          headers = {
              'Authorization': f'token {github_token}',
              'Accept': 'application/vnd.github+json'
          }
          data = {
              'body': f"## ðŸ¤– Gemini AI Review\n\n{review_comment}"
          }

          response = requests.post(api_url, headers=headers, json=data)
          if response.status_code == 201:
              print("Review posted successfully")
          else:
              print(f"Failed to post review: {response.status_code} {response.text}")
              sys.exit(0)
          PY
