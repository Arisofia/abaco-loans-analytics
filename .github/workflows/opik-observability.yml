name: Opik Observability & Monitoring

on:
  schedule:
    # Run daily at 9:00 AM CET (8:00 AM UTC) for system health monitoring
    - cron: '0 8 * * *'
  workflow_dispatch:

env:
  OPIKTOKEN: ${{ secrets.OPIK_TOKEN || secrets.OPIKTOKEN }}
  SUPABASESERVICEROLE: ${{ secrets.SUPABASE_SERVICE_ROLE || secrets.SUPABASESERVICEROLE }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

jobs:
  # Job 1: Fetch system metrics from Opik
  fetch-opik-metrics:

    runs-on: ubuntu-latest
    outputs:
      metrics-available: ${{ steps.fetch.outputs.available }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Fetch Opik system metrics
        id: fetch
        run: |
          echo "üìä Fetching Opik observability metrics..."
          if [ ! -f scripts/fetch_opik_metrics.py ]; then
            echo "Missing scripts/fetch_opik_metrics.py; skipping."
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          python scripts/fetch_opik_metrics.py
          echo "available=true" >> $GITHUB_OUTPUT

      - name: Upload metrics artifact
        if: ${{ steps.fetch.outputs.available == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: opik-metrics
          path: outputs/opik_metrics.json
          if-no-files-found: warn
          retention-days: 7

  # Job 2: Analyze data pipeline health
  analyze-pipeline-health:
    needs: fetch-opik-metrics
    if: ${{ needs.fetch-opik-metrics.result == 'success' && needs.fetch-opik-metrics.outputs.metrics-available == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      pipeline-status: ${{ steps.analyze.outputs.status }}
      issues-found: ${{ steps.analyze.outputs.issues }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Opik metrics
        uses: actions/download-artifact@v4
        with:
          name: opik-metrics
          path: outputs/

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Analyze pipeline health metrics
        id: analyze
        run: |
          echo "‚öïÔ∏è Analyzing data pipeline health..."
          if [ ! -f scripts/analyze_pipeline_health.py ]; then
            echo "Missing scripts/analyze_pipeline_health.py; skipping."
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "issues=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          python scripts/analyze_pipeline_health.py
          echo "status=healthy" >> $GITHUB_OUTPUT
          echo "issues=0" >> $GITHUB_OUTPUT

  # Job 3: Analyze agent execution performance
  analyze-agent-performance:
    needs: fetch-opik-metrics
    if: ${{ needs.fetch-opik-metrics.result == 'success' && needs.fetch-opik-metrics.outputs.metrics-available == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      agent-status: ${{ steps.analyze.outputs.status }}
      slow-agents: ${{ steps.analyze.outputs.slow_agents }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Opik metrics
        uses: actions/download-artifact@v4
        with:
          name: opik-metrics
          path: outputs/

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Analyze agent performance
        id: analyze
        run: |
          echo "üöÄ Analyzing agent execution performance..."
          if [ ! -f scripts/analyze_agent_performance.py ]; then
            echo "Missing scripts/analyze_agent_performance.py; skipping."
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "slow_agents=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi
          python scripts/analyze_agent_performance.py
          echo "status=optimal" >> $GITHUB_OUTPUT
          echo "slow_agents=none" >> $GITHUB_OUTPUT

  # Job 4: Check data quality trends
  check-data-quality-trends:
    needs: fetch-opik-metrics
    if: ${{ needs.fetch-opik-metrics.result == 'success' && needs.fetch-opik-metrics.outputs.metrics-available == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      quality-trend: ${{ steps.check.outputs.trend }}
      anomalies-detected: ${{ steps.check.outputs.anomalies }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Opik metrics
        uses: actions/download-artifact@v4
        with:
          name: opik-metrics
          path: outputs/

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Check data quality trends
        id: check
        run: |
          echo "üîç Checking data quality trends..."
          if [ ! -f scripts/check_data_quality_trends.py ]; then
            echo "Missing scripts/check_data_quality_trends.py; skipping."
            echo "trend=unknown" >> $GITHUB_OUTPUT
            echo "anomalies=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          python scripts/check_data_quality_trends.py
          echo "trend=stable" >> $GITHUB_OUTPUT
          echo "anomalies=false" >> $GITHUB_OUTPUT

  # Job 5: Generate observability dashboard
  generate-observability-dashboard:
    needs: [analyze-pipeline-health, analyze-agent-performance, check-data-quality-trends]
    if: ${{ needs.analyze-pipeline-health.result == 'success' && needs.analyze-agent-performance.result == 'success' && needs.check-data-quality-trends.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Generate dashboard
        run: |
          echo "üìä Generating observability dashboard..."
          if [ ! -f scripts/generate_observability_dashboard.py ]; then
            echo "Missing scripts/generate_observability_dashboard.py; skipping."
            exit 0
          fi
          python scripts/generate_observability_dashboard.py \
            --pipeline-status "${{ needs.analyze-pipeline-health.outputs.pipeline-status }}" \
            --agent-status "${{ needs.analyze-agent-performance.outputs.agent-status }}" \
            --quality-trend "${{ needs.check-data-quality-trends.outputs.quality-trend }}"

      - name: Upload dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: observability-dashboard
          path: outputs/dashboard.html
          if-no-files-found: warn
          retention-days: 30

  # Job 6: Alert on critical issues
  alert-on-critical-issues:
    needs: [analyze-pipeline-health, analyze-agent-performance, check-data-quality-trends]

    runs-on: ubuntu-latest
    steps:
      - name: Send critical alert to Slack
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        run: |
          echo "üö® Critical issue detected, sending alert..."
          ALERT_MESSAGE="üö® CRITICAL ALERT: System health issues detected\n"
          ALERT_MESSAGE+="Pipeline: ${{ needs.analyze-pipeline-health.outputs.pipeline-status }}\n"
          ALERT_MESSAGE+="Agents: ${{ needs.analyze-agent-performance.outputs.agent-status }}\n"
          ALERT_MESSAGE+="Data Quality: ${{ needs.check-data-quality-trends.outputs.quality-trend }}"

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"$ALERT_MESSAGE\"}"

  # Job 7: Daily system health summary
  send-daily-summary:
    needs: [analyze-pipeline-health, analyze-agent-performance, check-data-quality-trends, generate-observability-dashboard]

    runs-on: ubuntu-latest
    steps:
      - name: Send daily health summary to Slack
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        run: |
          echo "üìä Sending daily system health summary..."
          SUMMARY="üîç Daily System Health Report ($(date +%Y-%m-%d))\n\n"
          SUMMARY+="‚úÖ Data Pipeline: ${{ needs.analyze-pipeline-health.outputs.pipeline-status }}\n"
          SUMMARY+="ü§ñ Agent Performance: ${{ needs.analyze-agent-performance.outputs.agent-status }}\n"
          SUMMARY+="üìä Data Quality: ${{ needs.check-data-quality-trends.outputs.quality-trend }}\n\n"
          SUMMARY+="View detailed dashboard in GitHub Actions artifacts."

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"$SUMMARY\"}"
