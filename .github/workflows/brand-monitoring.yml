name: Brand Monitoring

on:
  schedule:
    - cron: "0 9 * * *" # 10:00 AM CET daily
  workflow_dispatch:

jobs:
  brand-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Check secrets availability
        id: check-secrets
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN || secrets.FACEBOOK_ACCESS_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          sanitize_secret() {
            local var_name="$1"
            local raw="$2"
            local norm
            norm="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]' | xargs)"
            case "$norm" in
              ""|"token"|"tokens"|"secret"|"secrets"|"changeme"|"change-me"|"change_me"|"replace-me"|"replace_me"|"placeholder"|"example"|"redacted")
                printf -v "$var_name" '%s' ""
                ;;
              *)
                printf -v "$var_name" '%s' "$raw"
                ;;
            esac
          }
          sanitize_secret OPENAI_API_KEY "$OPENAI_API_KEY"
          sanitize_secret META_ACCESS_TOKEN "$META_ACCESS_TOKEN"
          sanitize_secret SLACK_BOT_TOKEN "$SLACK_BOT_TOKEN"

          missing_required=""
          [ -z "$OPENAI_API_KEY" ] && missing_required="$missing_required OPENAI_API_KEY"
          [ -z "$META_ACCESS_TOKEN" ] && missing_required="$missing_required META_ACCESS_TOKEN"

          if [ -z "$missing_required" ]; then
            echo "can_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "can_run=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Missing required secrets:$missing_required - skipping monitoring"
          fi

          if [ -n "$SLACK_BOT_TOKEN" ]; then
            echo "slack_available=true" >> "$GITHUB_OUTPUT"
          else
            echo "slack_available=false" >> "$GITHUB_OUTPUT"
            echo "::warning::SLACK_BOT_TOKEN not configured - skipping Slack notification"
          fi
      - name: Install Dependencies
        if: ${{ steps.check-secrets.outputs.can_run == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run Brand Monitoring
        if: ${{ steps.check-secrets.outputs.can_run == 'true' && hashFiles('scripts/brand_monitoring.py') != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN || secrets.FACEBOOK_ACCESS_TOKEN }}
        run: |
          python scripts/brand_monitoring.py
      - name: Post to Slack
        if: ${{ steps.check-secrets.outputs.can_run == 'true' && steps.check-secrets.outputs.slack_available == 'true' && hashFiles('scripts/post_to_slack.py') != '' }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          python scripts/post_to_slack.py --channel "#brand-monitoring"
      - name: Monitoring Summary
        if: always()
        run: |
          echo "## Brand Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-secrets.outputs.can_run }}" == "true" ]; then
            echo "- **Monitoring**: ✅ Executed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Monitoring**: ⚠️ Skipped (missing required secrets)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check-secrets.outputs.slack_available }}" == "true" ]; then
            echo "- **Slack Notification**: ✅ Configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Slack Notification**: ⚠️ Not configured" >> $GITHUB_STEP_SUMMARY
          fi
