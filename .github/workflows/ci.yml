name: CI

permissions:
  contents: read
  pull-requests: read

on:
  workflow_dispatch:
    inputs:
      RUN_DEMOS:
        description: "Run demo scripts"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      DATA_FILE:
        description: "Path to CSV data file (relative to repo root)"
        required: false
        default: ""
  push:
    branches: [main, develop]
    paths:
      - "apps/**"
      - "python/**"
      - "scripts/**"
      - "tests/**"
      - "dashboard/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "apps/web/pnpm-lock.yaml"
      - "requirements*.txt"
      - ".github/workflows/ci.yml"
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 3 * * *" # Nightly at 3am UTC

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web || steps.force.outputs.web }}
      analytics: ${{ steps.filter.outputs.analytics || steps.force.outputs.analytics }}
      checks: ${{ steps.filter.outputs.checks || steps.force.outputs.checks }}
    steps:
      - uses: actions/checkout@v4
        if: github.event_name != 'schedule' && github.event_name != 'workflow_dispatch'
      - name: Force all checks for schedule/manual runs
        id: force
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "web=true" >> $GITHUB_OUTPUT
          echo "analytics=true" >> $GITHUB_OUTPUT
          echo "checks=true" >> $GITHUB_OUTPUT
      - name: Filter paths
        id: filter
        if: github.event_name != 'schedule' && github.event_name != 'workflow_dispatch'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            web:
              - "apps/web/**"
              - "package.json"
              - "pnpm-lock.yaml"
              - "apps/web/pnpm-lock.yaml"
              - ".github/workflows/ci.yml"
            analytics:
              - "apps/analytics/**"
              - "python/**"
              - "requirements.txt"
              - "apps/analytics/requirements.txt"
              - "tests/evaluation/**"
              - ".github/workflows/ci.yml"
            checks:
              - "scripts/**"
              - "python/**"
              - "tests/evaluation/**"
              - ".github/workflows/ci.yml"

  assignee-check:
    if: github.event_name == 'pull_request' && needs.changes.outputs.web == 'true'
    needs: changes
    uses: ./.github/workflows/pr-assignee-check.yml
    permissions:
      contents: read
      pull-requests: read
    with:
      assignees: ${{ github.event.pull_request.assignees }}

  repo-health:
    name: Repo Health Check
    needs: changes
    if: needs.changes.outputs.checks == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: apps/web/pnpm-lock.yaml
      - name: Install web deps (for lint)
        run: pnpm -C apps/web install --frozen-lockfile
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run repo health check
        continue-on-error: true
        run: bash scripts/repo_health_check.sh

  run-demos:
    name: Run Demo Scripts
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.RUN_DEMOS == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run Financial Analysis Demo
        continue-on-error: true
        env:
          DATA_FILE: ${{ inputs.DATA_FILE }}
        run: |
          if [ -n "$DATA_FILE" ]; then
            case "$DATA_FILE" in
              data/*.csv) ARGS="--data $DATA_FILE" ;;
              *) echo "Invalid DATA_FILE path"; exit 1 ;;
            esac
          else
            ARGS=""
          fi
          python scripts/demo_financial_analysis.py $ARGS > demo_output.txt || true
      - name: Generate Report
        if: always()
        continue-on-error: true
        run: |
          touch demo_output.txt
          python scripts/generate_markdown_report.py \
            --text demo_output.txt \
            --images dpd_distribution.png exposure_distribution.png \
            || echo "Report generation skipped (demo may not have run)"
      - name: Upload Demo Output
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: financial-analysis-demo
          path: |
            demo_output.txt
            demo_report.md
          if-no-files-found: ignore

  web:
    name: Web Build & Lint
    needs: changes
    if: needs.changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: apps/web/pnpm-lock.yaml
      - name: Install
        run: |
          pnpm -C apps/web install --frozen-lockfile
      - name: Type-check
        run: |
          pnpm -C apps/web type-check
      - name: Lint
        run: |
          pnpm -C apps/web lint
      - name: Build
        run: |
          pnpm -C apps/web build
      - name: Generate placeholder coverage (lcov)
        run: |
          mkdir -p apps/web/coverage
          echo "TN:\nSF:placeholder.js\nDA:1,0\nend_of_record" > apps/web/coverage/lcov.info

  analytics:
    name: Analytics Tests
    needs: changes
    if: needs.changes.outputs.analytics == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            apps/analytics/requirements.txt
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r apps/analytics/requirements.txt
          pip install pytest pytest-cov
      - name: Validate
        run: |
          python -c "import pandas as pd; print('Environment ready. Pandas version:', pd.__version__)"
      - name: Tests and coverage
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          cd apps/analytics
          pytest --cov=. --cov-report=xml:../coverage-python.xml
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: analytics-coverage
          path: apps/coverage-python.xml

  update-figma-slides:
    name: Update Figma Slides
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets availability
        id: check-secrets
        run: |
          if [ -n "${{ secrets.FIGMA_TOKEN }}" ] && [ -n "${{ secrets.FIGMA_FILE_KEY }}" ] && [ -n "${{ secrets.ANALYTICS_URL }}" ]; then
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          else
            echo "secrets_available=false" >> $GITHUB_OUTPUT
          fi
      - name: Checkout code
        if: steps.check-secrets.outputs.secrets_available == 'true'
        uses: actions/checkout@v4
      - name: Set up pnpm
        if: steps.check-secrets.outputs.secrets_available == 'true'
        uses: pnpm/action-setup@v3
        with:
          version: 10
      - name: Set up Node.js
        if: steps.check-secrets.outputs.secrets_available == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: apps/web/pnpm-lock.yaml
      - name: Install dependencies
        if: steps.check-secrets.outputs.secrets_available == 'true'
        run: pnpm install --frozen-lockfile
      - name: Update Figma Slides
        if: steps.check-secrets.outputs.secrets_available == 'true' && hashFiles('scripts/update_figma_slides.js') != ''
        run: node scripts/update_figma_slides.js
        env:
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          ANALYTICS_URL: ${{ secrets.ANALYTICS_URL }}

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs:
      - repo-health
      - run-demos
      - web
      - analytics
      - update-figma-slides
    if: always() && failure()
    steps:
      - name: Check Slack webhook availability
        id: slack_check
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Notify Slack on failure
        uses: slackapi/slack-github-action@v2
        if: steps.slack_check.outputs.available == 'true'
        with:
          webhook-type: INCOMING_WEBHOOK
          payload: |
            {
              "text": "ðŸš¨ CI Workflow Failed",
              "blocks": [
                { "type": "section", "text": { "type": "mrkdwn", "text": "*CI Workflow Failed*\\nRepository: ${{ github.repository }}\\nBranch: ${{ github.ref_name }}\\nCommit: ${{ github.sha }}\\n<${{ github.event.head_commit.url }}|View Commit>" } }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
