name: Export Meta Data to Azure

on:
  schedule:
    - cron: "0 2 * * *" # Diariamente a las 2 AM
  workflow_dispatch: # Manual trigger

jobs:
  export:

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check export secrets
        id: check-secrets
        env:
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN || secrets.FACEBOOK_ACCESS_TOKEN }}
          META_AD_ACCOUNT_ID: ${{ secrets.META_AD_ACCOUNT_ID || secrets.FACEBOOK_AD_ACCOUNT_ID }}
        run: |
          sanitize_secret() {
            local var_name="$1"
            local raw="$2"
            local norm
            norm="$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]' | xargs)"
            case "$norm" in
              ""|"token"|"tokens"|"secret"|"secrets"|"changeme"|"change-me"|"change_me"|"replace-me"|"replace_me"|"placeholder"|"example"|"redacted")
                printf -v "$var_name" '%s' ""
                ;;
              *)
                printf -v "$var_name" '%s' "$raw"
                ;;
            esac
          }
          sanitize_secret AZURE_STORAGE_CONNECTION_STRING "$AZURE_STORAGE_CONNECTION_STRING"
          sanitize_secret META_ACCESS_TOKEN "$META_ACCESS_TOKEN"
          sanitize_secret META_AD_ACCOUNT_ID "$META_AD_ACCOUNT_ID"

          missing=""
          [ -z "$AZURE_STORAGE_CONNECTION_STRING" ] && missing="$missing AZURE_STORAGE_CONNECTION_STRING"
          [ -z "$META_ACCESS_TOKEN" ] && missing="$missing META_ACCESS_TOKEN"
          [ -z "$META_AD_ACCOUNT_ID" ] && missing="$missing META_AD_ACCOUNT_ID"
          if [ -z "$missing" ]; then
            echo "can_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "can_run=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Missing required secrets:$missing"
          fi

      - name: Setup Node.js
        if: steps.check-secrets.outputs.can_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        if: steps.check-secrets.outputs.can_run == 'true'
        working-directory: ./node/services/meta-connector
        run: npm install

      - name: Compile TypeScript
        if: steps.check-secrets.outputs.can_run == 'true'
        working-directory: ./node/services/meta-connector
        run: npx tsc

      - name: Export to Azure
        if: steps.check-secrets.outputs.can_run == 'true'
        working-directory: ./node/services/meta-connector
        env:
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN || secrets.FACEBOOK_ACCESS_TOKEN }}
          META_AD_ACCOUNT_ID: ${{ secrets.META_AD_ACCOUNT_ID || secrets.FACEBOOK_AD_ACCOUNT_ID }}
        run: node dist/export_to_azure.js

      - name: Skip export (missing secrets)
        if: steps.check-secrets.outputs.can_run != 'true'
        run: |
          echo "Skipping Meta export: required secrets not configured."
