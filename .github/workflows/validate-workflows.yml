name: Validate Workflows

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  syntax-validation:
    name: Syntax Validation (actionlint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run actionlint
        uses: rint-action/actionlint@v1
        with:
          path: .github/workflows
          # fail_on_error: true  # defaults to failing the step on errors


  structure-validation:
    name: YAML Structure Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install yamllint
        run: |
          python -m pip install yamllint
      - name: Run yamllint
        run: yamllint .github/workflows

  dependency-validation:
    name: Dependency Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate dependencies (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip check

  trigger-validation:
    name: Trigger Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for missing workflow_dispatch
        run: |
          # Placeholder: run any project-specific trigger checks
          echo "ok"

  secrets-presence:
    uses: ./.github/workflows/reusable-secret-check.yml
    with:
      secrets: DOCKER_USERNAME,DOCKER_PASSWORD,AZURE_ACR_LOGIN_SERVER,AZURE_ACR_PASSWORD,AZURE_WEBAPP_PUBLISH_PROFILE,FIGMA_TOKEN
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      AZURE_ACR_LOGIN_SERVER: ${{ secrets.AZURE_ACR_LOGIN_SERVER }}
      AZURE_ACR_PASSWORD: ${{ secrets.AZURE_ACR_PASSWORD }}
      AZURE_WEBAPP_PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
      FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}

  secrets-validation:
    name: Secrets Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for hardcoded secrets
        run: |
          set -euo pipefail
          # Search for suspicious patterns; exclude common examples
          if grep -RIn --line-number -E "(AKIA|aws_secret|SECRET_KEY|PASSWORD|password=|SECRET=|API_KEY|PRIVATE_KEY)" --exclude-dir=.git -n . | grep -vE "example|\.env\.example|README"; then
            echo "Potential hardcoded secret(s) found" >&2
            exit 1
          fi

  summary:
    name: Workflow Validation Summary
    runs-on: ubuntu-latest
    needs:
      - syntax-validation
      - structure-validation
      - dependency-validation
      - trigger-validation
      - secrets-validation
      - secrets-presence
    if: |
      always() && (
        needs.syntax-validation.result == 'failure' ||
        needs.structure-validation.result == 'failure' ||
        needs.dependency-validation.result == 'failure' ||
        needs.trigger-validation.result == 'failure' ||
        needs.secrets-validation.result == 'failure' ||
        needs.secrets-presence.outputs.all_secrets_present == 'false'
      )
    steps:
      - name: Fail on validation error
        run: exit 1
