name: Meta Marketing Insights Ingest

on:
  schedule:
    - cron: "0 * * * *" # Every hour
  workflow_dispatch:

jobs:
  meta-ingest:
    runs-on: ubuntu-latest
    env:
      META_SYSTEM_USER_TOKEN: ${{ secrets.META_SYSTEM_USER_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Check Meta system user token
        id: meta_token
        run: |
          if [ -z "$META_SYSTEM_USER_TOKEN" ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
            echo "Missing META_SYSTEM_USER_TOKEN"
          else
            echo "run=true" >> "$GITHUB_OUTPUT"
          fi
      - name: Set up Node.js
        if: steps.meta_token.outputs.run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        if: steps.meta_token.outputs.run == 'true'
        run: |
          cd node/services/meta-connector
          npm install
      - name: Build
        if: steps.meta_token.outputs.run == 'true'
        run: |
          cd node/services/meta-connector
          npm run build
      - name: Run ingest
        if: steps.meta_token.outputs.run == 'true'
        run: |
          cd node/services/meta-connector
          node dist/ingest.js
      - name: Upload raw data
        if: steps.meta_token.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: meta-raw
          path: data/raw/meta/
      - name: Set up Python
        if: steps.meta_token.outputs.run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Load to warehouse
        if: steps.meta_token.outputs.run == 'true'
        run: |
          pip install pandas pyarrow pyyaml
          python python/ingestion/meta_to_warehouse.py
      - name: Upload warehouse parquet
        if: steps.meta_token.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: meta-warehouse
          path: data/warehouse/fact_marketing_spend.parquet
